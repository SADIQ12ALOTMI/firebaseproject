# مشروع "مشروع فايربيس المستخدمين"

> دليل شامل لإعداد وتشغيل تطبيق Flutter مرتبط بــ Firebase (Auth + Firestore) باستخدام **FlutterFire CLI**، مع شرح سير العمل والعمليات الأساسية.

---

## فهرس المحتويات

* [المتطلبات](#المتطلبات)
* [إنشاء مشروع Flutter](#إنشاء-مشروع-flutter)
* [إضافة الحزم](#إضافة-الحزم)
* [إنشاء مشروع Firebase وربطه](#إنشاء-مشروع-firebase-وربطه)

    * [إنشاء المشروع على Firebase Console](#إنشاء-المشروع-على-firebase-console)
    * [الربط عبر flutterfire-configure](#الربط-عبر-flutterfire-configure)
* [تهيئة المنصات](#تهيئة-المنصات)

    * [Android](#android)
    * [iOS](#ios)
    * [Web-اختياري](#web-اختياري)
* [تفعيل خدمات Firebase](#تفعيل-خدمات-firebase)

    * [Authentication (Email/Password)](#authentication-emailpassword)
    * [Cloud Firestore](#cloud-firestore)
    * [قواعد الأمان المبدئية](#قواعد-الأمان-المبدئية)
* [تهيئة التطبيق في Flutter](#تهيئة-التطبيق-في-flutter)

    * [`main()` و `firebase_options.dart`](#main-و-firebase_optionsdart)
    * [الثيم واللغات والملاحة](#الثيم-واللغات-والملاحة)
* [بنية الملفات المقترحة](#بنية-الملفات-المقترحة)
* [سير عمل التطبيق](#سير-عمل-التطبيق)

    * [SplashGate](#splashgate)
    * [AuthService](#authservice)
    * [UserRepo](#userrepo)
    * [شاشات المصادقة](#شاشات-المصادقة)
    * [Dashboard + Bottom Navigation](#dashboard--bottom-navigation)
    * [UsersView](#usersview)
    * [SettingsView](#settingsview)
* [بنية بيانات Firestore](#بنية-بيانات-firestore)
* [التشغيل محليًا](#التشغيل-محليًا)
* [البناء للإصدار](#البناء-للإصدار)
* [العمليات الأساسية (ملخص سريع)](#العمليات-الأساسية-ملخص-سريع)
* [استكشاف الأخطاء الشائعة](#استكشاف-الأخطاء-الشائعة)
* [تحسينات اختيارية](#تحسينات-اختيارية)
* [الترخيص](#الترخيص)

---

## المتطلبات

* **Flutter** (موصى به 3.22+):

  ```bash
  flutter --version
  ```
* **Dart** متوافق مع إصدار Flutter.
* **Firebase CLI**:

  ```bash
  npm i -g firebase-tools
  firebase login
  firebase --version
  ```
* **FlutterFire CLI**:

  ```bash
  dart pub global activate flutterfire_cli
  flutterfire --version
  ```
* حساب Google مفعّل عليه Firebase.

> **ملاحظة**: تأكد من تسجيل الدخول بنفس الحساب في Firebase CLI و FlutterFire CLI.

---

## إنشاء مشروع Flutter

إذا لم يكن لديك مشروع:

```bash
flutter create users_firebase_project
cd users_firebase_project
```

---

## إضافة الحزم

أضِف التبعيات التالية إلى `pubspec.yaml` ثم نفّذ `flutter pub get`:

```yaml
dependencies:
  flutter:
    sdk: flutter
  # Firebase core + الخدمات المستخدمة
  firebase_core: ^3.4.0
  firebase_auth: ^5.1.1
  cloud_firestore: ^5.2.1

  # للواجهة واللغة العربية
  flutter_localizations:
    sdk: flutter
```

> استخدم أحدث إصدارات متوافقة مع قناتك.

---

## إنشاء مشروع Firebase وربطه

### إنشاء المشروع على Firebase Console

1. افتح [Firebase Console](https://console.firebase.google.com/).
2. **Add project** واختر اسمًا (مثال: `userprofile-xxxx`).
3. أنشئ المشروع.

### الربط عبر `flutterfire configure`

من جذر مشروع Flutter:

```bash
flutterfire configure
```

* اختر مشروع Firebase الذي أنشأته.
* اختر المنصات (Android / iOS / Web) حسب الحاجة.
* سيُولِّد الملف: `lib/firebase_options.dart`.
* سيُسجّل التطبيقات للمنصات المحددة.

> إذا فشل إنشاء تطبيق الويب: حدّث Firebase CLI (وأعد تسجيل الدخول)، أو أنشئ تطبيق الويب يدويًا من Console ثم أعد `flutterfire configure`.

---

## تهيئة المنصات

### Android

* تأكد من توليد `android/app/google-services.json`.
* غالبًا يتم حقن الإعدادات تلقائيًا، وإلا:

    * في `android/build.gradle` (الجذر):

      ```gradle
      dependencies {
        classpath 'com.google.gms:google-services:4.4.2'
      }
      ```
    * في `android/app/build.gradle`:

      ```gradle
      apply plugin: 'com.google.gms.google-services'
      ```
* إن ظهرت أخطاء `namespace` لحِزم قديمة: أضِف `namespace` مناسبًا داخل بلوك `android { }` أو حدّث الحزمة.

### iOS

* تأكد من وجود `ios/Runner/GoogleService-Info.plist`.
* افتح المشروع في Xcode أول مرة للتأكد من الدمج الصحيح.

### Web (اختياري)

* لا حاجة لتعديل `web/index.html` عادة، حيث يعتمد التطبيق على `firebase_options.dart`.

---

## تفعيل خدمات Firebase

### Authentication (Email/Password)

* **Firebase Console → Authentication → Get started**.
* فعّل **Email/Password**.

### Cloud Firestore

* **Firestore Database → Create database**.
* اختر **Production mode** (ثم عدّل القواعد حسب حاجتك).

### قواعد الأمان المبدئية

> قواعد مبسطة للبدء — راجعها قبل الإنتاج:

```text
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

---

## تهيئة التطبيق في Flutter

### `main()` و `firebase_options.dart`

استخدم التهيئة القياسية:

```dart
await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
```

حيث يأتي `DefaultFirebaseOptions` من الملف المُولَّد: `lib/firebase_options.dart`.

### الثيم واللغات والملاحة

* التطبيق يضبط ثيمين (فاتح/داكن)، واللغة العربية `ar-SA`، ويستخدم `navigatorKey` و `onGenerateRoute` لإدارة التنقل.

---

## بنية الملفات المقترحة

```text
lib/
  main.dart
  firebase_options.dart        # مُولَّد بواسطة flutterfire configure
  services/
    auth_service.dart          # AuthService (FirebaseAuth)
    user_repo.dart             # UserRepo (Cloud Firestore)
  ui/
    splash_gate.dart           # شاشة البداية (التحقق من الجلسة)
    auth/
      sign_in_view.dart
      sign_up_view.dart
    dashboard/
      dashboard_view.dart      # BottomNav + تبويبات
      users_view.dart          # عرض المستخدمين
      settings_view.dart       # الإعدادات / الخروج
    widgets/
      background_shapes.dart
  router/
    app_router.dart            # (اختياري) فصل الموجه
```

> يمكنك إبقاء كل شيء في ملف واحد كما في العينة، لكن التفكيك أسهل صيانةً.

---

## سير عمل التطبيق

### SplashGate

* تستمع إلى `authService.auth$` (Stream\<User?>) لتحديد الوجهة:

    * `null` → الانتقال إلى **تسجيل الدخول**.
    * **غير null** → الانتقال إلى **الداشبورد**.
* تعرض دورانًا بسيطًا (AnimationController) أثناء الانتظار.

### AuthService

* `signIn(email, password)` — تسجيل الدخول.
* `signUp(email, password, displayName)` — إنشاء الحساب وتحديث اسم العرض.
* `signOut()` — تسجيل الخروج.
* `auth$` — تيار حالة المستخدم.
* `current` — المستخدم الحالي (إن وُجد).

### UserRepo

* `createUserDoc(user, name)` — إنشاء مستند مستخدم في `users/{uid}`:

    * `uid, name, email, photoUrl, createdAt, lastSeenAt` (timestamps خادمية).
* `users$()` — جلب آخر 100 مستخدم بترتيب تنازلي حسب `createdAt` (Stream).
* `touchLastSeen(uid)` — تحديث `lastSeenAt` إلى `serverTimestamp()`.

### شاشات المصادقة

* **SignInView**: نموذج بريد/كلمة مرور → `authService.signIn` → Dashboard.
* **SignUpView**: نموذج اسم/بريد/كلمة مرور → `authService.signUp` ثم `userRepo.createUserDoc` → Dashboard.

### Dashboard + Bottom Navigation

* تبويبان:

    1. **UsersView** (قائمة المستخدمين)
    2. **SettingsView** (الحساب/التفضيلات/الخروج)
* يستخدم `IndexedStack` لعدم فقدان حالة التبويب عند التبديل.

### UsersView

* `StreamBuilder` على `userRepo.users$()`
* لكل مستخدم بطاقة تحتوي: الاسم، البريد، وتاريخ الإنشاء.
* زر **"تحديث آخر ظهور"** يستدعي `touchLastSeen` للحساب الحالي.

### SettingsView

* ترويسة متدرّجة بأيقونة وصفيحة حساب.
* بطاقة حساب (الاسم/البريد).
* بطاقة تفضيلات (لغة/مظهر — حالياً ثابتة للعرض).
* زر **"تسجيل الخروج"** مع حوار تأكيد ثم `authService.signOut()` وإرجاعك إلى شاشة الدخول.

---

## بنية بيانات Firestore

* مجموعة: **`users`**

    * مستند: **`{uid}`**

        * `uid`: String
        * `name`: String
        * `email`: String
        * `photoUrl`: String?
        * `createdAt`: `FieldValue.serverTimestamp()`
        * `lastSeenAt`: `FieldValue.serverTimestamp()`

> ملاحظة: استخدام `serverTimestamp()` قد يظهر `null` لحظيًا حتى تصل القيمة من الخادم ويُحدِّث الـ Stream.

---

## التشغيل محليًا

### Android

```bash
flutter run -d android
```

### iOS

```bash
flutter run -d ios
```

> أول مرة: افتح `ios/Runner.xcworkspace` من Xcode للتوقيع الآمن إن لزم.

### Web (اختياري)

```bash
flutter run -d chrome
```

---

## البناء للإصدار

### Android (APK/AAB)

```bash
flutter build apk --release
# أو
flutter build appbundle --release
```

> لا تنسَ إعداد التوقيع للنشر على Play.

### iOS

```bash
flutter build ios --release
```

> إدارة الشهادات وملفات التعريف عبر Xcode و App Store Connect.

---

## العمليات الأساسية (ملخص سريع)

* **التحقق التلقائي من الجلسة**: `SplashGate` عبر `authService.auth$`.
* **تسجيل الدخول**: `SignInView._login()` → `authService.signIn`.
* **إنشاء حساب**: `SignUpView._register()` → `authService.signUp` → `userRepo.createUserDoc`.
* **تسجيل الخروج**: `SettingsView._confirmLogout()` → `authService.signOut`.
* **جلب المستخدمين**: `UsersView` عبر `userRepo.users$()`.
* **تحديث آخر ظهور**: `userRepo.touchLastSeen(uid)`.

---

## استكشاف الأخطاء الشائعة

### 1) فشل `flutterfire configure` في إنشاء تطبيق الويب

* حدّث Firebase CLI وأعد تسجيل الدخول:

  ```bash
  npm i -g firebase-tools
  firebase logout
  firebase login
  flutterfire configure
  ```
* أو أنشئ تطبيق الويب يدويًا من Console ثم أعد `flutterfire configure`.

### 2) `Firebase.initializeApp` لا يجد `firebase_options.dart`

* تأكد أن `flutterfire configure` أنشأ `lib/firebase_options.dart`.
* تأكد من الاستيراد:

  ```dart
  import 'firebase_options.dart';
  ```

### 3) Firestore لا يقرأ/يكتب

* راجع **قواعد الأمان**.
* تأكد من تمكين Firestore من Console وأن المستخدم **مسجّل دخول**.

### 4) أخطاء Android Gradle/Namespace

* لبعض الحِزم القديمة، أضف:

  ```gradle
  android {
    namespace "com.example.users_firebase_project" // مثال
  }
  ```
* أو حدّث الحزمة المسببة للمشكلة.

### 5) iOS — مشاكل التوقيع أو الشبكة

* افتح المشروع في Xcode، عالج التوقيع.
* أضف المفاتيح المطلوبة في `Info.plist` إذا كنت تحتاج صلاحيات/شبكة خاصة.

---

## تحسينات اختيارية

* فصل الملفات (Services/Repo/Views/Router) لسهولة الصيانة.
* إضافة تحديث الاسم/الصورة من الإعدادات.
* فلاتر/بحث في قائمة المستخدمين.
* تحسين قواعد الأمان لتناسب حالات الأعمال.

---

## الترخيص

هذا المشروع تعليمي. استخدمه كأساس وكيّفه وفق احتياجات تطبيقك.
